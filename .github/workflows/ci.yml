name: CI

on:
  push:
    branches: [ develop, feature/* ]
  pull_request:
    branches: [ develop ]

jobs:
  backend-js:
    name: Backend (JavaScript/NestJS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm install
      
      - name: Build
        working-directory: ./backend
        run: npm run build
      
      - name: Lint
        working-directory: ./backend
        run: |
          npm run lint || echo "Linting skipped"
        continue-on-error: true

  data-generator-python:
    name: Data Generator (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./data-generator
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Lint
        working-directory: ./data-generator
        run: |
          pip install flake8
          flake8 . --count --max-line-length=88 --exclude=__pycache__ || echo "Linting skipped"
        continue-on-error: true

  web-app-python:
    name: Web App (Python/Streamlit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./web-app
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Lint
        working-directory: ./web-app
        run: |
          pip install flake8
          flake8 . --count --max-line-length=88 --exclude=__pycache__ || echo "Linting skipped"
        continue-on-error: true

  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Docker Compose
        run: docker-compose up -d --build
      
      - name: Wait for services
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          docker-compose ps
      
      - name: Test API
        run: |
          for i in {1..10}; do
            if curl -f http://localhost:8000/health --max-time 5; then
              echo "API is available"
              exit 0
            fi
            echo "Attempt $i/10: API not ready, waiting..."
            sleep 5
          done
          echo "API unavailable after 10 attempts"
          exit 1
        continue-on-error: true
